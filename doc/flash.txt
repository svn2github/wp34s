Commands to handle the flash memory on the real calculator
==========================================================

Hold down ON (EXIT) and press one of the following keys:

STO - Backup:  This creates a copy of the RAM in flash memory.

RCL - Restore: This restores a previously created backup. 

D - Debug:     Disables all power saving. Unlocks the following ON+S
               combination. The small "=" is lit.

S - SAM-BA:    Clears the GPNVM1 bit and turns the calculator off.
               S is on the '6' key. Works only in debug mode.
               ATTENTION: You can now only boot into SAM-BA mode!
               Without the SAM-BA software and the cable, you're lost!

These ON key combinations have to be pressed twice in a row without
releasing the ON key to be executed.

Do an ON+STO before you want to flash a new release or change the 
batteries! Afterwards, your backup should still be in place if you 
didn't accidently press the ERASE button on the cable but used ON+S 
instead to get into SAM-BA boot mode.

I/O commands in the P.FCN catalogue:

PSTO     Store the current program in the flash library.
         Alphanumeric labels in flash can be called with XEQ.
         Use the label browser (CAT, f+RCL) to see the labels.

PRCL     Restore a program to RAM where data can be edited.
         You can PRCL a program from RAM to RAM to make duplicate.

LOAD     Executes ON+RCL. This is available on the emulator, too.

SAVE     Executes ON+STO. See above.

RRCL     Recall the register data only from a previously created backup.

SRCL     Recall the setup data only from a previously created backup.

You can recall a group of registers from the backup with the command
R-COPY from the program catalogue. Just give it a negative value in X
and the source block will be fetched from flash instead of RAM. 


Mapping from memory regions to emulator state files
===================================================

Region     state file       Remark
----------------------------------------------------------
  Lib     wp34s-lib.dat     The library in flash
 Backup   wp34s-backup.dat  The backup (SAVEed)
  RAM     wp34s.dat         Emulator image of the RAM area

wp34s.dat is only written on exit of the emulator software.
wp34s-lib.dat is written each time a flash command is executed.
wp34s-backup.dat is created by the SAVE command.
All files are only read into memory on emulator startup. 


How to transfer data between the calculator and your PC (SAM-BA)
================================================================

This discussion is superceded by the new serial I/O commands. It's
still interesting enough to leave it here as a reference.

The whole RAM is saved to address 0x11f800 (relative address 0x1f800)
with ON+STO. This can be copied to your PC or loaded from it.

1. From calculator to PC

   a) Do an ON+STO, then ON+D then ON+S with the cable connected.
   b) Press ON once and start SAM-BA on the PC. It should connect.
   c) Set the start address to 0x11F800 and the size to 0x800
   d) Enter a file name in the receive field.
   e) You can now receive the file with SAM-BA.
   f) Move it under the name wp34s.dat into your emulator directory.
   g) The emulator should accept the file. Your registers and programs
      will than be in place.
   h) To get your calculator back in business, start the "Boot from flash"
      script in SAM-BA, the same procedure you should know from flashing
      the firmware.
   i) Reset and power the calculator up and perform a restore with ON+RCL.
      The latest version does the restore automatically when RAM is lost.

2. From PC to calculator

   a) Perform steps (a) to (c) from above. No need to set the size.
   b) Point SAM-BA to your wp34s.dat file from the emulator.
   c) You can now send the short file with SAM-BA.
   d) Perform steps (h) and (i) from above.


How to transfer data between the calculator and your PC (Serial I/O)
====================================================================

Both the emulator and the calculator can talk to each other with the
same cable used for programming. In the emulator directory a text file
wp34s.ini must be placed that contains the name of the port such as COM2:

On the receiver (emulator or calculator) execute RECV (from P.FCN).

On the sender, you can send data with the following P.FCN commands:

SENDA   sends all memory including state.
SENDP   sends the currently selected program. It may reside in any
        memory area in the calculator. It is appended to the programs
        already in RAM on the receiving device.
SENDR   sends the numbered registers.

On a device without the crystal installed, the baud rate setting may be
a bit too far off and you will get "I/O Error". The commands accept a
correction factor in percent in X. Try with 95 if your device is a bit too
slow or 105 if it is a bit too fast. Values between 80 and 120 are valid
all other values are ignored.

On the emulator or with the crystal installed, X is ignored. 
