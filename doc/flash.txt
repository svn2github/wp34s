Commands to handle the flash memory on the real calculator
==========================================================

Hold down ON (EXIT) and press one of the following keys:

STO - Backup:  This creates a copy of the RAM in flash memory.

RCL - Restore: This restores a previously created backup. 

D - Debug:     Disables all power saving. Unlocks the following ON+S
               combination. The small "=" is lit.

S - SAM-BA:    Clears the GPNVM1 bit and turns the calculator off.
               S is on the '6' key. Works only in debug mode.
               ATTENTION: You can now only boot into SAM-BA boot mode!
               Without the SAM-BA software and the cable, you're lost!
	       ON+S is disabled until ON+D is active. This shall prevent
	       accidental access to this possibly dangerous feature.

These ON key combinations have to be pressed twice in a row without
releasing the ON key to be executed.

Do an ON+STO before you want to flash a new release or change the 
batteries! Afterwards, your backup should still be in place if you 
didn't accidently press the ERASE button on the cable but used ON+S 
instead to get into SAM-BA boot mode.

I/O commands in the P.FCN catalogue:

PSTO     Store the current program in the flash library. The program
         needs to have an alphanumeric label somewhere. Alphanumeric
	 labels in flash can be called with XEQ. Use the label browser
	 (CAT, accessed with h-shift RCL) to see the labels.
	 If a program with the same label exists in the library it will
	 be removed first. The new data is always added at the end of
	 the library in flash memory.

PRCL     Restore a program to RAM where data can be edited. You can 
         PRCL a program from RAM to RAM to make a duplicate.

LOAD     Executes ON+RCL. This is available on the emulator, too.

SAVE     Executes ON+STO. See above.

LOADR    Recall the register data only from a previously created backup.
         The command just recalls the numbered registers, not the stack
	 or special registers.

LOADS    Recall the setup data only from a previously created backup.

LOAD[SIGMA] Recall the summation data from the backup.

You can recall a group of registers from the backup with the command
R-COPY from the program catalogue. Just give it a negative value in X
and the source block will be fetched from flash instead of RAM. 


Mapping from memory regions to emulator state files
===================================================

Region     state file       Remark
----------------------------------------------------------
  Lib     wp34s-lib.dat     The library in flash
 Backup   wp34s-backup.dat  The backup (SAVEed)
  RAM     wp34s.dat         Emulator image of the RAM area

wp34s.dat is only written on exit of the emulator software.
wp34s-lib.dat is written each time a flash command is executed.
wp34s-backup.dat is created by the SAVE command.
All files are only read into memory on emulator startup. 


How to transfer data between the calculator and your PC (SAM-BA)
================================================================

This discussion is superceded by the new serial I/O commands. It's
still interesting enough to leave it here as a reference. It needs
Atmel's original SAM_BA.exe program. For regular flashing of the
firmware, MySamba from the flashtools directory on SF is recommended.

The whole RAM is saved to address 0x11f800 (relative address 0x1f800)
with ON+STO. This can be copied to your PC or loaded from it.

1. From calculator to PC

   a) Do an ON+STO, then ON+D then ON+S with the cable connected.
   b) Press ON once and start SAM-BA on the PC. It should connect.
   c) Set the start address to 0x11F800 and the size to 0x800
   d) Enter a file name in the receive field.
   e) You can now receive the file with SAM-BA.
   f) Move it under the name wp34s.dat into your emulator directory.
   g) The emulator should accept the file. Your registers and programs
      will than be in place.
   h) To get your calculator back in business, start the "Boot from flash"
      script in SAM-BA, the same procedure you might already know from 
      flashing the firmware with this tool.
   i) Reset and power the calculator up. The RAM is automatically
      restored from the backup.

2. From PC to calculator

   a) Perform steps (a) to (c) from above. No need to set the size.
   b) Point SAM-BA to your wp34s.dat file from the emulator.
   c) You can now send the short file with SAM-BA.
   d) Perform steps (h) and (i) from above.


How to transfer data between the calculator and your PC (Serial I/O)
====================================================================

Both the emulator and the calculator can talk to each other with the
same cable used for programming. In the emulator directory a text file
wp34s.ini must be placed that contains the name of the port such as COM2:
The new Qt based emulators for Windows and MacOS contain a setup option
for the serial interface. They will eventually replace the current
Windows emulator completely. With a proper cable it is even possible to
transfer data between two calculators with the same set of commands.

On the receiver (emulator or calculator) execute RECV (from P.FCN).

On the sender, you can send data with the following P.FCN commands:

SENDA   sends all memory, including state.
SENDP   sends the currently selected program. It may reside in any
        memory area in the calculator. It is appended to the programs
        already in RAM on the receiving device.
SENDR   sends the numbered registers.

On a device without the crystal installed, the baud rate setting may be
a bit too far off and you will get "I/O Error". The commands accept a
correction factor in percent in X. Try with 95 if your device is a bit too
slow or 105 if it is a bit too fast. Values between 80 and 120 are valid
all other values are ignored.

On the emulator or with the crystal installed, X is ignored. 
